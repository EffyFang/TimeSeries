---
title: "TSProject_Kai"
author: "Kai Li"
date: "August 19, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 

```{r message=FALSE}
# load libraries
library(caret)
library(TSA)
library(pls)
library(forecast)
library(tseries)
library(vars)
```



```{r}
df = readRDS("~/GitHub/TimeSeries-Project/TSProject/new_train.rds")

df1 = df[,10:12]
lan = as.numeric(df1[,1])
jia = as.numeric(df1[,2])
shen = as.numeric(df1[,3])
```

```{r}
Acf(lan)
Acf(jia)
Acf(shen)
```


```{r}

## use log rather than auto lambda




jia_daily = ts(as.numeric(df1[,2]), frequency = 365)
lan_daily = ts(as.numeric(df1[,1]), frequency = 365)
shen_daily = ts(as.numeric(df1[,3]), frequency = 365)

jia_weekly = ts(as.numeric(df1[,2]), frequency = 7)
lan_weekly = ts(as.numeric(df1[,1]), frequency = 7)
shen_weekly = ts(as.numeric(df1[,3]), frequency = 7)


lan_train_weekly = window(lan_weekly, start = c(1,1), end = c(112,7))
lan_test_weekly = window(lan_weekly, start = c(113,1), end = c(115,5))

jia_train_weekly = window(jia_weekly, start = c(1,1), end = c(112,7))
jia_test_weekly = window(jia_weekly, start = c(113,1), end = c(115,5))


jia_train_daily = window(jia_daily, start = c(1,1), end = c(3,61))
jia_test_daily = window(jia_daily, start = c(3,62), end = c(3,73))



shen_train_weekly = window(shen_weekly, start = c(1,1), end = c(112,7))
shen_test_weekly = window(shen_weekly, start = c(113,1), end = c(115,5))

```


```{r}
autoplot(lan_train_weekly)+
  autolayer(lan_test_weekly)
```



```{r}


var_data = window(ts.union(shen_train_weekly, lan_train_weekly))


model_var = VAR(y = var_data, p = 2)
pred = predict(model_var, h = 12)
pred_shen = pred$fcst$shen_train_weekly[,1]
pred_shen = ts(pred_shen, start = c(114, 1), end = c(115,5), frequency = 7)
autoplot(pred_shen, include = 100)+
  autolayer(shen_test_weekly,series = "SARIMA", color = "red")


pred_lan = pred$fcst$lan_train_weekly[,1]
pred_lan = ts(pred_lan, start = c(114, 1), end = c(115,5), frequency = 7)
autoplot(pred_lan)+
  autolayer(lan_test_weekly,series = "SARIMA", color = "red")
```


```{r}
cbind(lan,shen,jia)
ts.plot()
# before Ts and train test split

```


```{r}
ts.plot(lan)
acf(lan)
pacf(lan)
```


```{r}
ts.plot(jia)
acf(jia)
pacf(jia)
```



```{r}
ts.plot(shen)
acf(shen)
pacf(shen)
```




```{r}

model_auto = auto.arima(lan_train_weekly, lambda = "auto", seasonal = TRUE)
model_auto
lambda = model_auto$lambda[1]

model_auto$coef
acf(model_auto$residuals)
pacf(model_auto$residuals)
checkresiduals(model_auto)

pred = forecast(model_auto, h = 12)
accuracy(pred, lan_test_weekly)

autoplot(pred, include = 100)+
  autolayer(lan_test_weekly,series = "SARIMA", color = "red")


```


```{r}
eacf(jia_train_weekly)
#model_auto = auto.arima(jia_train_weekly, lambda = "auto", seasonal = TRUE)
model_auto = Arima(jia_train_weekly, lambda = "auto", order=c(1,1,2))
model_auto

model_auto$coef
acf(model_auto$residuals)
pacf(model_auto$residuals)
checkresiduals(model_auto)

pred = forecast(model_auto, h = 12)
accuracy(pred, jia_test_weekly)

autoplot(pred, include = 12)+
  autolayer(jia_test_weekly,series = "SARIMA", color = "red")
```


```{r}

model_auto = auto.arima(jia_train_daily, lambda = "auto", seasonal = TRUE)
model_auto

model_auto$coef
Acf(model_auto$residuals)
pacf(model_auto$residuals)
checkresiduals(model_auto)

pred = forecast(model_auto, h = 12)
accuracy(pred, jia_test_daily)

autoplot(pred, include = 100)+
  autolayer(jia_test_daily,series = "SARIMA", color = "red")
```


```{r}
temp = tbats(lan_train_weekly)
checkresiduals(temp)
temp

## ARFIMA class 7

```


```{r}
# use partial lag, lag = 0.111  TBATS
model_auto = auto.arima(log(jia_train_weekly),  seasonal = TRUE)
model_auto

model_auto$coef
Acf(model_auto$residuals)
pacf(model_auto$residuals)
checkresiduals(model_auto)

pred = forecast(model_auto, h = 12)
accuracy(pred, jia_test_weekly)

autoplot(exp(pred$mean))+
  autolayer(jia_test_weekly,series = "SARIMA", color = "red")
```





```{r}

model_auto = auto.arima(jia1, lambda = "auto", seasonal = TRUE)
model_auto

model_auto$coef
acf(model_auto$residuals)
pacf(model_auto$residuals)
```





```{r}

model_auto = auto.arima(shen1, lambda = "auto", seasonal = TRUE)
model_auto

model_auto$coef
acf(model_auto$residuals)
pacf(model_auto$residuals)
checkresiduals(model_auto)
```




```{r}
tbats()
```


```{r}

model_xreg = auto.arima(lan_train_weekly, xreg=shen_train_weekly,lambda = "auto")
model_xreg
checkresiduals(model_xreg)

pred = forecast(model_xreg, xre = shen_test_weekly, h = 19)
accuracy(pred, lan_test_weekly)

autoplot(pred, include = 10)+
  autolayer(lan_test_weekly,series = "SARIMA", color = "red")

```



```{r}
summary(ses(jia1))
```

```{r}
library(fpp2)
harmonics = fourier(shen_train_weekly, K =2)
fit = auto.arima(lan_train_weekly, xreg = harmonics, seasonal = FALSE)

new_harmonics = fourier(shen_train_weekly, K =2, h = 12)
pred = forecast(fit, xreg = new_harmonics)

accuracy(pred, shen_test_weekly)

autoplot(pred, include = 10)+
  autolayer(shen_test_weekly,series = "SARIMA", color = "red")
```

